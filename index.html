import React, { useState, useCallback, useMemo, useRef, useEffect } from 'react';

const App = () => {
  const [threads, setThreads] = useState([]);
  const [activeThreadId, setActiveThreadId] = useState(null);
  const [newMessage, setNewMessage] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [newThreadName, setNewThreadName] = useState('');
  const [errorBanner, setErrorBanner] = useState(null);
  const chatEndRef = useRef(null);

  const generateId = () => crypto.randomUUID();

  const currentThread = useMemo(() => threads.find(t => t.id === activeThreadId), [threads, activeThreadId]);

  const addMessagesToThread = (threadId, userMsg, aiMsg) => {
    setThreads(prev => prev.map(t => {
      if(t.id === threadId) {
        const newMessages = [...t.messages];
        if(userMsg) newMessages.push(userMsg);
        if(aiMsg) newMessages.push(aiMsg);
        return {...t, messages: newMessages};
      }
      return t;
    }));
  };

  const callGemini = async (history) => {
    const response = await fetch('/api/gemini-chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({messages: history.map(m => ({role: m.role, text: m.text}))})
    });

    if(!response.ok) {
      const err = await response.json();
      throw new Error(err.error || 'Gemini request failed');
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
  };

  const handleSendMessage = useCallback(async (e) => {
    e.preventDefault();
    if(!newMessage.trim() || !currentThread || isGenerating) return;

    const userMsgObj = {role: 'user', text: newMessage.trim(), timestamp: Date.now()};
    const updatedHistory = [...currentThread.messages, userMsgObj];

    setNewMessage('');
    setIsGenerating(true);
    setErrorBanner(null);

    try {
      addMessagesToThread(currentThread.id, userMsgObj, null);
      const aiResponse = await callGemini(updatedHistory);
      const aiMsgObj = {role: 'model', text: aiResponse.trim(), timestamp: Date.now() + 1};
      addMessagesToThread(currentThread.id, null, aiMsgObj);
    } catch(error) {
      setErrorBanner(`AI generation failed: ${error.message}`);
    } finally {
      setIsGenerating(false);
    }
  }, [newMessage, currentThread, isGenerating]);

  useEffect(() => {
    if(chatEndRef.current) chatEndRef.current.scrollIntoView({behavior: 'smooth'});
  }, [threads, activeThreadId]);

  const handleCreateThread = () => {
    if(!newThreadName.trim()) return;
    const newThread = {
      id: generateId(),
      name: newThreadName.trim(),
      createdAt: Date.now(),
      messages: [{role:'system', text: `Welcome to '${newThreadName.trim()}' thread!`}]
    };
    setThreads(prev => [newThread, ...prev]);
    setActiveThreadId(newThread.id);
    setNewThreadName('');
    setIsModalOpen(false);
  };

  const isButtonDisabled = !currentThread || !newMessage.trim() || isGenerating;
  const disabledReason = isGenerating ? 'Generating Response...' :
    !currentThread ? 'No Thread Selected' : 'Message is Empty';

  return (
    <div style={{display:'flex', height:'100vh', fontFamily:'sans-serif'}}>
      {isModalOpen && (
        <div style={{position:'fixed', inset:0, backgroundColor:'rgba(0,0,0,0.75)', display:'flex', justifyContent:'center', alignItems:'center', zIndex:50}}>
          <div style={{backgroundColor:'#222', padding:20, borderRadius:8, width:300}}>
            <h3 style={{color:'#a0aec0', marginBottom:12}}>Name Your Idea Thread</h3>
            <input
              style={{width:'100%', padding:8, borderRadius:6, border:'1px solid #4a5568', backgroundColor:'#2d3748', color:'white'}}
              value={newThreadName}
              onChange={e => setNewThreadName(e.target.value)}
              onKeyDown={e => e.key==='Enter' && handleCreateThread()}
              placeholder="Thread Name"
              autoFocus
            />
            <div style={{marginTop:12, display:'flex', justifyContent:'flex-end', gap:8}}>
              <button onClick={() => {setIsModalOpen(false); setNewThreadName('')}} style={{backgroundColor:'#4a5568', color:'white', padding:'6px 12px', borderRadius:6}}>Cancel</button>
              <button onClick={handleCreateThread} disabled={!newThreadName.trim()} style={{backgroundColor:'#667eea', color:'white', padding:'6px 12px', borderRadius:6}}>Create</button>
            </div>
          </div>
        </div>
      )}

      <aside style={{width:260, backgroundColor:'#2d3748', padding:16, display:'flex', flexDirection:'column'}}>
        <h1 style={{color:'#667eea', fontSize:18, marginBottom:20}}>Idea Threads</h1>
        <button onClick={() => setIsModalOpen(true)} style={{padding:10, marginBottom:20, backgroundColor:'#667eea', color:'white', borderRadius:6, border:'none'}}>+ New Thread</button>
        <nav style={{flexGrow:1, overflowY:'auto'}}>
          {threads.length===0 ? <p style={{color:'#a0aec0', fontStyle:'italic'}}>No threads yet</p> : threads.map(t => (
            <button
              key={t.id}
              onClick={() => setActiveThreadId(t.id)}
              style={{
                display:'block',
                width:'100%',
                padding:'10px 12px',
                marginBottom:8,
                textAlign:'left',
                backgroundColor:t.id===activeThreadId ? '#4c51bf' : '#4a5568',
                color:'white',
                borderRadius:6,
                border:'none',
                cursor:'pointer'
              }}
              title={t.name}
            >
              {t.name}
            </button>
          ))}
        </nav>
        {errorBanner && (
          <div style={{marginTop:10, padding:8, backgroundColor:'#c53030', color:'white', borderRadius:6}}>
            {errorBanner} <button onClick={() => setErrorBanner(null)} style={{marginLeft:8, textDecoration:'underline', cursor:'pointer'}}>Dismiss</button>
          </div>
        )}
      </aside>

      <main style={{flexGrow:1, backgroundColor:'#1a202c', display:'flex', flexDirection:'column'}}>
        <header style={{padding:16, borderBottom:'1px solid #4a5568', backgroundColor:'#2d3748'}}>
          <h2 style={{fontSize:20, fontWeight:'bold', color:'white', whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis'}}>
            {currentThread?.name ?? 'Select or Create a Thread'}
          </h2>
        </header>

        <div style={{flexGrow:1, overflowY:'auto', padding:16, display:'flex', flexDirection:'column', gap:12}}>
          {currentThread ? currentThread.messages.map((msg,i) => (
            <div key={i} style={{alignSelf: msg.role==='user' ? 'flex-end' : 'flex-start', maxWidth:'70%', padding:12, borderRadius:12, backgroundColor: msg.role==='user' ? '#667eea' : '#4a5568', color:'white'}}>
              <div style={{fontSize:12, opacity:0.7, marginBottom:6, fontWeight:'bold'}}>
                {msg.role==='user' ? 'You' : 'Assistant'}
              </div>
              <div style={{whiteSpace:'pre-wrap', wordWrap:'break-word'}}>
                {msg.text}
              </div>
            </div>
          )) : <p style={{marginTop:40, color:'#718096', textAlign:'center'}}>Start a new thread to begin your novel brainstorm!</p>}
          {isGenerating && (
            <div style={{alignSelf:'flex-start', padding:12, borderRadius:12, backgroundColor:'#4a5568', color:'white', fontStyle:'italic', opacity:0.9}}>
              Assistant thinking...
            </div>
          )}
          <div ref={chatEndRef} />
        </div>

        <footer style={{padding:16, borderTop:'1px solid #4a5568', backgroundColor:'#2d3748'}}>
          <form style={{display:'flex', gap:8}} onSubmit={handleSendMessage}>
            <input
              type="text"
              value={newMessage}
              onChange={e => setNewMessage(e.target.value)}
              placeholder={currentThread ? "Ask the AI a question about this thread's content..." : 'Select a thread first...'}
              disabled={!currentThread || isGenerating}
              style={{flexGrow:1, padding:12, borderRadius:12, border:'none', backgroundColor:'#4a5568', color:'white', fontSize:16}}
            />
            <button type="submit" disabled={isButtonDisabled} title={disabledReason} style={{padding:'12px 24px', borderRadius:12, border:'none', backgroundColor:isButtonDisabled ? '#3c366f' : '#667eea', color:'white', fontWeight:'bold', cursor:isButtonDisabled ? 'not-allowed' : 'pointer'}}>
              {isGenerating ? 'Generating...' : 'Generate'}
            </button>
          </form>
        </footer>
      </main>
    </div>
  );
};

export default App;
